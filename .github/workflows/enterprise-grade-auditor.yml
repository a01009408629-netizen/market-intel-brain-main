name: ğŸ›ï¸ Enterprise-Grade Comprehensive Auditor

on:
  push:
    branches: [ main, master, develop, staging ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run comprehensive audit daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      audit_level:
        description: 'Audit Level'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - comprehensive
          - critical-only

# Advanced concurrency control with environment-specific isolation
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  AUDIT_TIMEOUT: '30m'
  CACHE_VERSION: 'v2'

jobs:
  # ===== PYTHON COMPREHENSIVE AUDIT =====
  python-security-audit:
    name: ğŸ”’ Python Security & Quality Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Advanced Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements*.txt
            **/requirements*.txt
      
      - name: ğŸ“¦ Install Dependencies with Security Scanning
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # Install requirements with security checks
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements_production.txt ]; then
            pip install -r requirements_production.txt
          fi
          
          # Install advanced audit tools
          pip install \
            ruff==0.15.2 \
            mypy==1.19.1 \
            bandit==1.9.3 \
            safety==3.2.4 \
            semgrep==1.68.0 \
            pip-audit==2.7.3 \
            pyright==1.1.352 \
            black==24.4.2 \
            isort==5.13.2 \
            flake8==7.0.0 \
            vulture==2.11 \
            pre-commit==3.7.1
      
      - name: ğŸ” Advanced Syntax & Quality Check (Ruff)
        run: |
          ruff check . --output-format=github --show-fixes
          ruff format --check .
        continue-on-error: true
      
      - name: ğŸ›¡ï¸ Comprehensive Type Checking (MyPy + Pyright)
        run: |
          echo "Running MyPy analysis..."
          mypy . --ignore-missing-imports --show-error-codes --no-error-summary || true
          
          echo "Running Pyright analysis..."
          pyright --outputjson || true
        continue-on-error: true
      
      - name: ğŸ”’ Deep Security Analysis (Bandit + Safety + Semgrep)
        run: |
          echo "Running Bandit security scan..."
          bandit -r . -f json -o bandit-report.json || true
          
          echo "Running Safety dependency check..."
          safety check --json --output safety-report.json || true
          
          echo "Running Semgrep static analysis..."
          semgrep --config=auto --json --output=semgrep-report.json . || true
        continue-on-error: true
      
      - name: ğŸ” Dead Code Detection (Vulture)
        run: vulture . --min-confidence 80 || true
        continue-on-error: true
      
      - name: ğŸ“Š Code Complexity Analysis
        run: |
          pip install radon
          radon cc . --show-complexity --min C
          radon mi . --show
        continue-on-error: true
      
      - name: ğŸ“‹ Generate Comprehensive Report
        run: |
          echo "# Python Audit Report - Python ${{ matrix.python-version }}" > audit-report.md
          echo "Generated: $(date)" >> audit-report.md
          echo "" >> audit-report.md
          
          if [ -f bandit-report.json ]; then
            echo "## Security Issues (Bandit)" >> audit-report.md
            cat bandit-report.json | jq -r '.results[] | "- \(.test_name): \(.issue_text)"' >> audit-report.md
          fi
          
          if [ -f safety-report.json ]; then
            echo "## Dependency Vulnerabilities (Safety)" >> audit-report.md
            cat safety-report.json | jq -r '.vulnerabilities[] | "- \(.advisory): \(.vulnerable_spec)"' >> audit-report.md
          fi
      
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-audit-py${{ matrix.python-version }}
          path: |
            bandit-report.json
            safety-report.json
            semgrep-report.json
            audit-report.md
          retention-days: 30

  # ===== NODE.JS COMPREHENSIVE AUDIT =====
  nodejs-security-audit:
    name: ğŸ“¦ Node.js Security & Quality Audit
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Advanced Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: ğŸ“¦ Install Dependencies with Security Scanning
        run: |
          if [ -f package-lock.json ]; then
            npm ci --audit=false
          else
            npm install
          fi
          
          # Install advanced audit tools
          npm install -g \
            eslint@8.57.0 \
            typescript@5.4.5 \
            @typescript-eslint/parser@7.8.0 \
            @typescript-eslint/eslint-plugin@7.8.0 \
            prettier@3.2.5 \
            npm-audit-resolver@1.0.2 \
            snyk@1.1291.0
      
      - name: ğŸ” Advanced Linting (ESLint + Prettier)
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ]; then
            npx eslint . --format=github --max-warnings=0 || true
          fi
          
          if [ -f .prettierrc ] || grep -q '"prettier"' package.json; then
            npx prettier --check . || true
          fi
        continue-on-error: true
      
      - name: ğŸ›¡ï¸ TypeScript Analysis
        run: |
          if [ -f tsconfig.json ]; then
            npx tsc --noEmit --strict --skipLibCheck || true
          fi
        continue-on-error: true
      
      - name: ğŸ”’ Comprehensive Security Audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate --json > npm-audit.json || true
          
          echo "Running Snyk security scan..."
          if command -v snyk &> /dev/null; then
            snyk test --json > snyk-report.json || true
          fi
        continue-on-error: true
      
      - name: ğŸ“Š Bundle Analysis
        run: |
          if [ -f package.json ] && npm run | grep -q 'build'; then
            npm run build
            if [ -f "dist" ]; then
              du -sh dist/
              find dist -name "*.js" -exec wc -c {} + | sort -n
            fi
          fi
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Node.js Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-audit
          path: |
            npm-audit.json
            snyk-report.json
          retention-days: 30

  # ===== INFRASTRUCTURE & CONFIGURATION AUDIT =====
  infrastructure-audit:
    name: ğŸ—ï¸ Infrastructure & Configuration Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Docker Security Analysis
        run: |
          if [ -f Dockerfile ]; then
            echo "Analyzing Dockerfile..."
            docker run --rm -v "$PWD":/app hadolint/hadolint /app/Dockerfile || true
          fi
          
          if [ -f docker-compose.yml ]; then
            echo "Analyzing docker-compose.yml..."
            docker-compose config --quiet || true
          fi
        continue-on-error: true
      
      - name: ğŸ”’ Secrets Detection
        run: |
          # Install and run truffleHog
          pip install truffleHog
          truffleHog --regex --entropy=False . --json > secrets-scan.json || true
        continue-on-error: true
      
      - name: ğŸ“‹ Configuration Validation
        run: |
          echo "Validating configuration files..."
          
          # Validate YAML files
          find . -name "*.yml" -o -name "*.yaml" | xargs -I {} python -c "
          import yaml
          import sys
          try:
              with open(sys.argv[1]) as f:
                  yaml.safe_load(f)
              print(f'âœ“ {sys.argv[1]}')
          except Exception as e:
              print(f'âœ— {sys.argv[1]}: {e}')
          " {}
          
          # Validate JSON files
          find . -name "*.json" -not -path "./node_modules/*" | xargs -I {} python -c "
          import json
          import sys
          try:
              with open(sys.argv[1]) as f:
                  json.load(f)
              print(f'âœ“ {sys.argv[1]}')
          except Exception as e:
              print(f'âœ— {sys.argv[1]}: {e}')
          " {}
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Infrastructure Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-audit
          path: |
            secrets-scan.json
          retention-days: 30

  # ===== PERFORMANCE & BENCHMARK AUDIT =====
  performance-audit:
    name: âš¡ Performance & Benchmark Audit
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install Performance Tools
        run: |
          pip install \
            pytest==8.2.0 \
            pytest-benchmark==4.0.0 \
            memory-profiler==0.61.0 \
            line-profiler==4.1.1 \
            py-spy==0.3.14
      
      - name: âš¡ Performance Benchmarking
        run: |
          if [ -f test_basic.py ]; then
            echo "Running performance benchmarks..."
            python -m pytest test_basic.py --benchmark-only --benchmark-json=benchmark.json || true
          fi
        continue-on-error: true
      
      - name: ğŸ“Š Memory Profiling
        run: |
          if [ -f simple_api_server.py ]; then
            echo "Running memory profiling..."
            python -m memory_profiler simple_api_server.py > memory-profile.txt || true
          fi
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Performance Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-audit
          path: |
            benchmark.json
            memory-profile.txt
          retention-days: 30

  # ===== COMPREHENSIVE REPORT GENERATION =====
  generate-comprehensive-report:
    name: ğŸ“Š Generate Comprehensive Report
    runs-on: ubuntu-latest
    needs: [python-security-audit, nodejs-security-audit, infrastructure-audit, performance-audit]
    if: always()
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: ğŸ“Š Generate Master Report
        run: |
          echo "# ğŸ›ï¸ Enterprise-Grade Comprehensive Audit Report" > master-report.md
          echo "" >> master-report.md
          echo "**Generated:** $(date)" >> master-report.md
          echo "**Repository:** ${{ github.repository }}" >> master-report.md
          echo "**Commit:** ${{ github.sha }}" >> master-report.md
          echo "" >> master-report.md
          
          echo "## ğŸ“Š Executive Summary" >> master-report.md
          echo "- **Python Audit:** ${{ needs.python-security-audit.result }}" >> master-report.md
          echo "- **Node.js Audit:** ${{ needs.nodejs-security-audit.result }}" >> master-report.md
          echo "- **Infrastructure Audit:** ${{ needs.infrastructure-audit.result }}" >> master-report.md
          echo "- **Performance Audit:** ${{ needs.performance-audit.result }}" >> master-report.md
          echo "" >> master-report.md
          
          echo "## ğŸ” Detailed Findings" >> master-report.md
          
          # Process Python audit results
          if [ -d "artifacts/python-audit-py3.11" ]; then
            echo "### Python Security Issues" >> master-report.md
            if [ -f "artifacts/python-audit-py3.11/bandit-report.json" ]; then
              cat artifacts/python-audit-py3.11/bandit-report.json | jq -r '.results | length' | xargs -I {} echo "- Total Bandit Issues: {}" >> master-report.md
            fi
          fi
          
          # Process Node.js audit results
          if [ -d "artifacts/nodejs-audit" ]; then
            echo "### Node.js Security Issues" >> master-report.md
            if [ -f "artifacts/nodejs-audit/npm-audit.json" ]; then
              cat artifacts/nodejs-audit/npm-audit.json | jq -r '.vulnerabilities | length' | xargs -I {} echo "- Total NPM Vulnerabilities: {}" >> master-report.md
            fi
          fi
          
          echo "" >> master-report.md
          echo "## ğŸ“ˆ Recommendations" >> master-report.md
          echo "1. Address high-severity security issues immediately" >> master-report.md
          echo "2. Update dependencies to latest stable versions" >> master-report.md
          echo "3. Implement automated security scanning in CI/CD" >> master-report.md
          echo "4. Regular performance monitoring and optimization" >> master-report.md
      
      - name: ğŸ“¤ Upload Master Report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-audit-report
          path: master-report.md
          retention-days: 90
      
      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('master-report.md')) {
              const report = fs.readFileSync('master-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ›ï¸ Enterprise Audit Report\n\n${report}`
              });
            }

  # ===== NOTIFICATION & ALERTING =====
  notify-results:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [generate-comprehensive-report]
    if: always() && (needs.generate-comprehensive-report.result == 'failure' || github.event_name == 'schedule')
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“§ Send Notification
        run: |
          echo "Audit completed with status: ${{ needs.generate-comprehensive-report.result }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
