# Prometheus Rules for Market Intel Brain SLOs and Alerting
# Defines Service Level Objectives, Recording Rules, and Alerts for Go Gateway and Rust Engine

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: market-intel-brain-slos
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: observability
    tier: slos
  annotations:
    description: "Service Level Objectives and alerting rules for Market Intel Brain"
    version: "v1.0.0"
spec:
  groups:
    # API Gateway SLO Rules
    - name: market-intel-brain.api-gateway.slo.rules
      interval: 30s
      rules:
        # Recording Rules - API Gateway Availability
        - record: market_intel_brain:api_gateway:availability:rate5m
          expr: |
            sum(rate(http_requests_total{job="api-gateway",code!~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[5m]))
          labels:
            service: "api-gateway"
            slo_type: "availability"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:availability:rate30m
          expr: |
            sum(rate(http_requests_total{job="api-gateway",code!~"5.."}[30m]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[30m]))
          labels:
            service: "api-gateway"
            slo_type: "availability"
            window: "30m"
        
        - record: market_intel_brain:api_gateway:availability:rate1h
          expr: |
            sum(rate(http_requests_total{job="api-gateway",code!~"5.."}[1h]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[1h]))
          labels:
            service: "api-gateway"
            slo_type: "availability"
            window: "1h"
        
        # Recording Rules - API Gateway Error Rate
        - record: market_intel_brain:api_gateway:error_rate:rate5m
          expr: |
            sum(rate(http_requests_total{job="api-gateway",code=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[5m]))
          labels:
            service: "api-gateway"
            slo_type: "error_rate"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:error_rate:rate30m
          expr: |
            sum(rate(http_requests_total{job="api-gateway",code=~"5.."}[30m]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[30m]))
          labels:
            service: "api-gateway"
            slo_type: "error_rate"
            window: "30m"
        
        # Recording Rules - API Gateway Latency
        - record: market_intel_brain:api_gateway:latency_p50:rate5m
          expr: |
            histogram_quantile(0.50,
              sum(rate(http_request_duration_seconds_bucket{job="api-gateway"}[5m])) by (le)
            )
          labels:
            service: "api-gateway"
            slo_type: "latency"
            percentile: "p50"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:latency_p90:rate5m
          expr: |
            histogram_quantile(0.90,
              sum(rate(http_request_duration_seconds_bucket{job="api-gateway"}[5m])) by (le)
            )
          labels:
            service: "api-gateway"
            slo_type: "latency"
            percentile: "p90"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:latency_p95:rate5m
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_request_duration_seconds_bucket{job="api-gateway"}[5m])) by (le)
            )
          labels:
            service: "api-gateway"
            slo_type: "latency"
            percentile: "p95"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:latency_p99:rate5m
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket{job="api-gateway"}[5m])) by (le)
            )
          labels:
            service: "api-gateway"
            slo_type: "latency"
            percentile: "p99"
            window: "5m"
        
        # Recording Rules - API Gateway Throughput
        - record: market_intel_brain:api_gateway:throughput:rate5m
          expr: |
            sum(rate(http_requests_total{job="api-gateway"}[5m]))
          labels:
            service: "api-gateway"
            slo_type: "throughput"
            window: "5m"
        
        # Recording Rules - API Gateway Saturation
        - record: market_intel_brain:api_gateway:cpu_usage:rate5m
          expr: |
            sum(rate(container_cpu_usage_seconds_total{pod=~"api-gateway-.*"}[5m])) by (pod)
          labels:
            service: "api-gateway"
            slo_type: "cpu_usage"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:memory_usage:rate5m
          expr: |
            sum(container_memory_working_set_bytes{pod=~"api-gateway-.*"}) by (pod)
          labels:
            service: "api-gateway"
            slo_type: "memory_usage"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:memory_usage_percent:rate5m
          expr: |
            (sum(container_memory_working_set_bytes{pod=~"api-gateway-.*"}) by (pod) /
            sum(container_spec_memory_limit_bytes{pod=~"api-gateway-.*"}) by (pod)) * 100
          labels:
            service: "api-gateway"
            slo_type: "memory_usage_percent"
            window: "5m"
        
        # Recording Rules - API Gateway Circuit Breaker
        - record: market_intel_brain:api_gateway:circuit_breaker_open:rate5m
          expr: |
            sum(rate(circuit_breaker_state{job="api-gateway",state="open"}[5m]))
          labels:
            service: "api-gateway"
            slo_type: "circuit_breaker_open"
            window: "5m"
        
        # Recording Rules - API Gateway Error Budget
        - record: market_intel_brain:api_gateway:error_budget:rate5m
          expr: |
            (1 - market_intel_brain:api_gateway:availability:rate5m) * 100
          labels:
            service: "api-gateway"
            slo_type: "error_budget"
            window: "5m"
        
        - record: market_intel_brain:api_gateway:error_budget_remaining:rate5m
          expr: |
            (99.9 - market_intel_brain:api_gateway:error_budget:rate5m)
          labels:
            service: "api-gateway"
            slo_type: "error_budget_remaining"
            window: "5m"

    # Core Engine SLO Rules
    - name: market-intel-brain.core-engine.slo.rules
      interval: 30s
      rules:
        # Recording Rules - Core Engine Availability
        - record: market_intel_brain:core_engine:availability:rate5m
          expr: |
            sum(rate(grpc_server_handled_total{job="core-engine",grpc_code!~"Internal|Unavailable|DeadlineExceeded|Unknown"}[5m]))
            /
            sum(rate(grpc_server_handled_total{job="core-engine"}[5m]))
          labels:
            service: "core-engine"
            slo_type: "availability"
            window: "5m"
        
        - record: market_intel_brain:core_engine:availability:rate30m
          expr: |
            sum(rate(grpc_server_handled_total{job="core-engine",grpc_code!~"Internal|Unavailable|DeadlineExceeded|Unknown"}[30m]))
            /
            sum(rate(grpc_server_handled_total{job="core-engine"}[30m]))
          labels:
            service: "core-engine"
            slo_type: "availability"
            window: "30m"
        
        - record: market_intel_brain:core_engine:availability:rate1h
          expr: |
            sum(rate(grpc_server_handled_total{job="core-engine",grpc_code!~"Internal|Unavailable|DeadlineExceeded|Unknown"}[1h]))
            /
            sum(rate(grpc_server_handled_total{job="core-engine"}[1h]))
          labels:
            service: "core-engine"
            slo_type: "availability"
            window: "1h"
        
        # Recording Rules - Core Engine Error Rate
        - record: market_intel_brain:core_engine:error_rate:rate5m
          expr: |
            sum(rate(grpc_server_handled_total{job="core-engine",grpc_code=~"Internal|Unavailable|DeadlineExceeded|Unknown"}[5m]))
            /
            sum(rate(grpc_server_handled_total{job="core-engine"}[5m]))
          labels:
            service: "core-engine"
            slo_type: "error_rate"
            window: "5m"
        
        - record: market_intel_brain:core_engine:error_rate:rate30m
          expr: |
            sum(rate(grpc_server_handled_total{job="core-engine",grpc_code=~"Internal|Unavailable|DeadlineExceeded|Unknown"}[30m]))
            /
            sum(rate(grpc_server_handled_total{job="core-engine"}[30m]))
          labels:
            service: "core-engine"
            slo_type: "error_rate"
            window: "30m"
        
        # Recording Rules - Core Engine Latency
        - record: market_intel_brain:core_engine:latency_p50:rate5m
          expr: |
            histogram_quantile(0.50,
              sum(rate(grpc_server_handling_seconds_bucket{job="core-engine"}[5m])) by (le)
            )
          labels:
            service: "core-engine"
            slo_type: "latency"
            percentile: "p50"
            window: "5m"
        
        - record: market_intel_brain:core_engine:latency_p90:rate5m
          expr: |
            histogram_quantile(0.90,
              sum(rate(grpc_server_handling_seconds_bucket{job="core-engine"}[5m])) by (le)
            )
          labels:
            service: "core-engine"
            slo_type: "latency"
            percentile: "p90"
            window: "5m"
        
        - record: market_intel_brain:core_engine:latency_p95:rate5m
          expr: |
            histogram_quantile(0.95,
              sum(rate(grpc_server_handling_seconds_bucket{job="core-engine"}[5m])) by (le)
            )
          labels:
            service: "core-engine"
            slo_type: "latency"
            percentile: "p95"
            window: "5m"
        
        - record: market_intel_brain:core_engine:latency_p99:rate5m
          expr: |
            histogram_quantile(0.99,
              sum(rate(grpc_server_handling_seconds_bucket{job="core-engine"}[5m])) by (le)
            )
          labels:
            service: "core-engine"
            slo_type: "latency"
            percentile: "p99"
            window: "5m"
        
        # Recording Rules - Core Engine Throughput
        - record: market_intel_brain:core_engine:throughput:rate5m
          expr: |
            sum(rate(grpc_server_handled_total{job="core-engine"}[5m]))
          labels:
            service: "core-engine"
            slo_type: "throughput"
            window: "5m"
        
        # Recording Rules - Core Engine Saturation
        - record: market_intel_brain:core_engine:cpu_usage:rate5m
          expr: |
            sum(rate(container_cpu_usage_seconds_total{pod=~"core-engine-.*"}[5m])) by (pod)
          labels:
            service: "core-engine"
            slo_type: "cpu_usage"
            window: "5m"
        
        - record: market_intel_brain:core_engine:memory_usage:rate5m
          expr: |
            sum(container_memory_working_set_bytes{pod=~"core-engine-.*"}) by (pod)
          labels:
            service: "core-engine"
            slo_type: "memory_usage"
            window: "5m"
        
        - record: market_intel_brain:core_engine:memory_usage_percent:rate5m
          expr: |
            (sum(container_memory_working_set_bytes{pod=~"core-engine-.*"}) by (pod) /
            sum(container_spec_memory_limit_bytes{pod=~"core-engine-.*"}) by (pod)) * 100
          labels:
            service: "core-engine"
            slo_type: "memory_usage_percent"
            window: "5m"
        
        # Recording Rules - Core Engine Error Budget
        - record: market_intel_brain:core_engine:error_budget:rate5m
          expr: |
            (1 - market_intel_brain:core_engine:availability:rate5m) * 100
          labels:
            service: "core-engine"
            slo_type: "error_budget"
            window: "5m"
        
        - record: market_intel_brain:core_engine:error_budget_remaining:rate5m
          expr: |
            (99.9 - market_intel_brain:core_engine:error_budget:rate5m)
          labels:
            service: "core-engine"
            slo_type: "error_budget_remaining"
            window: "5m"

    # System-wide SLO Rules
    - name: market-intel-brain.system.slo.rules
      interval: 30s
      rules:
        # Recording Rules - System Availability
        - record: market_intel_brain:system:availability:rate5m
          expr: |
            (market_intel_brain:api_gateway:availability:rate5m + 
             market_intel_brain:core_engine:availability:rate5m) / 2
          labels:
            service: "system"
            slo_type: "availability"
            window: "5m"
        
        # Recording Rules - System Error Budget
        - record: market_intel_brain:system:error_budget:rate5m
          expr: |
            (market_intel_brain:api_gateway:error_budget:rate5m + 
             market_intel_brain:core_engine:error_budget:rate5m) / 2
          labels:
            service: "system"
            slo_type: "error_budget"
            window: "5m"
        
        - record: market_intel_brain:system:error_budget_remaining:rate5m
          expr: |
            (99.9 - market_intel_brain:system:error_budget:rate5m)
          labels:
            service: "system"
            slo_type: "error_budget_remaining"
            window: "5m"

    # API Gateway Alerts
    - name: market-intel-brain.api-gateway.alerts
      rules:
        # Availability Alerts
        - alert: APIGatewayHighErrorRate
          expr: market_intel_brain:api_gateway:error_rate:rate5m > 0.001
          for: 5m
          labels:
            severity: critical
            service: api-gateway
            slo_type: availability
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/high-error-rate"
          annotations:
            summary: "API Gateway error rate is above SLO threshold"
            description: "API Gateway error rate is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the SLO threshold of 0.1%."
            runbook: "Check API Gateway logs for error patterns, verify upstream service health, and consider scaling or circuit breaker adjustments."
        
        - alert: APIGatewaySLOBreached
          expr: market_intel_brain:api_gateway:availability:rate30m < 0.999
          for: 10m
          labels:
            severity: critical
            service: api-gateway
            slo_type: availability
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/slo-breached"
          annotations:
            summary: "API Gateway SLO breached"
            description: "API Gateway availability is {{ $value | humanizePercentage }} over the last 30 minutes, which is below the SLO target of 99.9%."
            runbook: "Immediate investigation required. Check system health, recent deployments, and consider rollback if necessary."
        
        # Latency Alerts
        - alert: APIGatewayHighLatencyWarning
          expr: market_intel_brain:api_gateway:latency_p99:rate5m > 0.05
          for: 5m
          labels:
            severity: warning
            service: api-gateway
            slo_type: latency
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/high-latency"
          annotations:
            summary: "API Gateway P99 latency is above warning threshold"
            description: "API Gateway P99 latency is {{ $value | humanizeDuration }} over the last 5 minutes, which exceeds the warning threshold of 50ms."
            runbook: "Investigate performance bottlenecks, check database query performance, and consider scaling or optimization."
        
        - alert: APIGatewayHighLatencyCritical
          expr: market_intel_brain:api_gateway:latency_p99:rate5m > 0.1
          for: 2m
          labels:
            severity: critical
            service: api-gateway
            slo_type: latency
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/high-latency-critical"
          annotations:
            summary: "API Gateway P99 latency is above critical threshold"
            description: "API Gateway P99 latency is {{ $value | humanizeDuration }} over the last 5 minutes, which exceeds the critical threshold of 100ms."
            runbook: "Immediate action required. Check for resource saturation, database issues, or network problems."
        
        # Saturation Alerts
        - alert: APIGatewayHighCPUUsage
          expr: market_intel_brain:api_gateway:cpu_usage:rate5m > 0.8
          for: 10m
          labels:
            severity: warning
            service: api-gateway
            slo_type: saturation
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/high-cpu"
          annotations:
            summary: "API Gateway CPU usage is high"
            description: "API Gateway CPU usage is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the threshold of 80%."
            runbook: "Consider scaling horizontally or optimizing CPU-intensive operations."
        
        - alert: APIGatewayHighMemoryUsage
          expr: market_intel_brain:api_gateway:memory_usage_percent:rate5m > 80
          for: 10m
          labels:
            severity: warning
            service: api-gateway
            slo_type: saturation
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/high-memory"
          annotations:
            summary: "API Gateway memory usage is high"
            description: "API Gateway memory usage is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the threshold of 80%."
            runbook: "Check for memory leaks and consider increasing memory limits or optimizing memory usage."
        
        # Circuit Breaker Alerts
        - alert: APIGatewayCircuitBreakerOpen
          expr: market_intel_brain:api_gateway:circuit_breaker_open:rate5m > 0
          for: 1m
          labels:
            severity: critical
            service: api-gateway
            slo_type: circuit_breaker
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/circuit-breaker-open"
          annotations:
            summary: "API Gateway circuit breaker is open"
            description: "API Gateway circuit breaker is open, indicating upstream service issues."
            runbook: "Check upstream service health and consider manual circuit breaker reset if services are healthy."
        
        # Throughput Alerts
        - alert: APIGatewayLowThroughput
          expr: market_intel_brain:api_gateway:throughput:rate5m < 10
          for: 5m
          labels:
            severity: warning
            service: api-gateway
            slo_type: throughput
            team: platform
            runbook_url: "https://runbooks.market-intel.com/api-gateway/low-throughput"
          annotations:
            summary: "API Gateway throughput is low"
            description: "API Gateway throughput is {{ $value }} requests/second over the last 5 minutes, which is unusually low."
            runbook: "Check for service availability, network issues, or application problems."

    # Core Engine Alerts
    - name: market-intel-brain.core-engine.alerts
      rules:
        # Availability Alerts
        - alert: CoreEngineHighErrorRate
          expr: market_intel_brain:core_engine:error_rate:rate5m > 0.001
          for: 5m
          labels:
            severity: critical
            service: core-engine
            slo_type: availability
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/high-error-rate"
          annotations:
            summary: "Core Engine error rate is above SLO threshold"
            description: "Core Engine error rate is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the SLO threshold of 0.1%."
            runbook: "Check Core Engine logs for error patterns, verify database connectivity, and investigate business logic issues."
        
        - alert: CoreEngineSLOBreached
          expr: market_intel_brain:core_engine:availability:rate30m < 0.999
          for: 10m
          labels:
            severity: critical
            service: core-engine
            slo_type: availability
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/slo-breached"
          annotations:
            summary: "Core Engine SLO breached"
            description: "Core Engine availability is {{ $value | humanizePercentage }} over the last 30 minutes, which is below the SLO target of 99.9%."
            runbook: "Immediate investigation required. Check system health, recent deployments, and consider rollback if necessary."
        
        # Latency Alerts
        - alert: CoreEngineHighLatencyWarning
          expr: market_intel_brain:core_engine:latency_p99:rate5m > 0.05
          for: 5m
          labels:
            severity: warning
            service: core-engine
            slo_type: latency
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/high-latency"
          annotations:
            summary: "Core Engine P99 latency is above warning threshold"
            description: "Core Engine P99 latency is {{ $value | humanizeDuration }} over the last 5 minutes, which exceeds the warning threshold of 50ms."
            runbook: "Investigate performance bottlenecks, check database query performance, and consider optimization."
        
        - alert: CoreEngineHighLatencyCritical
          expr: market_intel_brain:core_engine:latency_p99:rate5m > 0.1
          for: 2m
          labels:
            severity: critical
            service: core-engine
            slo_type: latency
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/high-latency-critical"
          annotations:
            summary: "Core Engine P99 latency is above critical threshold"
            description: "Core Engine P99 latency is {{ $value | humanizeDuration }} over the last 5 minutes, which exceeds the critical threshold of 100ms."
            runbook: "Immediate action required. Check for resource saturation, database issues, or algorithmic problems."
        
        # Saturation Alerts
        - alert: CoreEngineHighCPUUsage
          expr: market_intel_brain:core_engine:cpu_usage:rate5m > 0.8
          for: 10m
          labels:
            severity: warning
            service: core-engine
            slo_type: saturation
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/high-cpu"
          annotations:
            summary: "Core Engine CPU usage is high"
            description: "Core Engine CPU usage is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the threshold of 80%."
            runbook: "Consider scaling horizontally or optimizing CPU-intensive operations."
        
        - alert: CoreEngineHighMemoryUsage
          expr: market_intel_brain:core_engine:memory_usage_percent:rate5m > 80
          for: 10m
          labels:
            severity: warning
            service: core-engine
            slo_type: saturation
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/high-memory"
          annotations:
            summary: "Core Engine memory usage is high"
            description: "Core Engine memory usage is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the threshold of 80%."
            runbook: "Check for memory leaks and consider increasing memory limits or optimizing memory usage."
        
        # Throughput Alerts
        - alert: CoreEngineLowThroughput
          expr: market_intel_brain:core_engine:throughput:rate5m < 10
          for: 5m
          labels:
            severity: warning
            service: core-engine
            slo_type: throughput
            team: platform
            runbook_url: "https://runbooks.market-intel.com/core-engine/low-throughput"
          annotations:
            summary: "Core Engine throughput is low"
            description: "Core Engine throughput is {{ $value }} requests/second over the last 5 minutes, which is unusually low."
            runbook: "Check for service availability, network issues, or application problems."

    # System-wide Alerts
    - name: market-intel-brain.system.alerts
      rules:
        # System Availability Alerts
        - alert: SystemHighErrorRate
          expr: market_intel_brain:system:error_budget:rate5m > 0.1
          for: 5m
          labels:
            severity: critical
            service: system
            slo_type: availability
            team: platform
            runbook_url: "https://runbooks.market-intel.com/system/high-error-rate"
          annotations:
            summary: "System error rate is above SLO threshold"
            description: "System error budget is {{ $value | humanizePercentage }} over the last 5 minutes, which exceeds the SLO threshold of 0.1%."
            runbook: "Check both API Gateway and Core Engine health, investigate system-wide issues."
        
        - alert: SystemSLOBreached
          expr: market_intel_brain:system:availability:rate30m < 0.999
          for: 10m
          labels:
            severity: critical
            service: system
            slo_type: availability
            team: platform
            runbook_url: "https://runbooks.market-intel.com/system/slo-breached"
          annotations:
            summary: "System SLO breached"
            description: "System availability is {{ $value | humanizePercentage }} over the last 30 minutes, which is below the SLO target of 99.9%."
            runbook: "Immediate investigation required. Consider emergency response procedures."
        
        # Error Budget Alerts
        - alert: SystemErrorBudgetDepleted
          expr: market_intel_brain:system:error_budget_remaining:rate5m < 0
          for: 1m
          labels:
            severity: critical
            service: system
            slo_type: error_budget
            team: platform
            runbook_url: "https://runbooks.market-intel.com/system/error-budget-depleted"
          annotations:
            summary: "System error budget is depleted"
            description: "System error budget is {{ $value | humanizePercentage }} over the last 5 minutes, which means the error budget has been depleted."
            runbook: "Emergency response required. Consider stopping deployments and focusing on stability."
