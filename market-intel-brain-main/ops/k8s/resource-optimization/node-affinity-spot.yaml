---
# Node Affinity and Tolerations for Spot Instances
# This configuration enables services to run on Spot Instances with proper scheduling

# Go Gateway Deployment with Spot Instance Affinity
apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-gateway-deployment
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: go-gateway
    deployment-type: spot-optimized
spec:
  replicas: 3
  selector:
    matchLabels:
      app: market-intel-brain
      component: go-gateway
  template:
    metadata:
      labels:
        app: market-intel-brain
        component: go-gateway
        spot-optimized: "true"
    spec:
      # Node affinity for spot instances
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-lifecycle
                operator: In
                values:
                - spot
              - key: spot-instance
                operator: In
                values:
                - "true"
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - go-gateway
          - weight: 50
            preference:
              matchExpressions:
              - key: cost-optimized
                operator: In
                values:
                - "true"
      # Pod anti-affinity for high availability
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app: market-intel-brain
                component: go-gateway
            topologyKey: kubernetes.io/hostname
      # Topology spread constraints
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: market-intel-brain
            component: go-gateway
      - maxSkew: 2
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: market-intel-brain
            component: go-gateway
      # Tolerations for spot instances
      tolerations:
      - key: "spot-instance"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      - key: "node-lifecycle"
        operator: "Equal"
        value: "spot"
        effect: "NoSchedule"
      # Termination handling
      terminationGracePeriodSeconds: 30
      containers:
      - name: go-gateway
        image: ghcr.io/a01009408629-netizen/market-intel-brain-go-gateway:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        env:
        - name: CLUSTER_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['cluster-name']
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SPOT_INSTANCE
          value: "true"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        # Graceful shutdown handling
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c"]
              args:
              - |
                echo "Pod received termination signal, starting graceful shutdown..."
                # Notify load balancer
                curl -X POST http://localhost:8080/health/shutdown || true
                # Wait for connections to drain
                sleep 15
                echo "Graceful shutdown completed"
        # Signal handling
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
---
# Rust Engine Deployment with Spot Instance Affinity
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rust-engine-deployment
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: rust-engine
    deployment-type: spot-optimized
spec:
  replicas: 2
  selector:
    matchLabels:
      app: market-intel-brain
      component: rust-engine
  template:
    metadata:
      labels:
        app: market-intel-brain
        component: rust-engine
        spot-optimized: "true"
    spec:
      # Node affinity for spot instances
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-lifecycle
                operator: In
                values:
                - spot
              - key: spot-instance
                operator: In
                values:
                - "true"
              - key: compute-optimized
                operator: In
                values:
                - "true"
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - rust-engine
          - weight: 50
            preference:
              matchExpressions:
              - key: cost-optimized
                operator: In
                values:
                - "true"
      # Pod anti-affinity for high availability
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app: market-intel-brain
                component: rust-engine
            topologyKey: kubernetes.io/hostname
      # Topology spread constraints
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: market-intel-brain
            component: rust-engine
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: market-intel-brain
            component: rust-engine
      # Tolerations for spot instances
      tolerations:
      - key: "spot-instance"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      - key: "node-lifecycle"
        operator: "Equal"
        value: "spot"
        effect: "NoSchedule"
      - key: "compute-optimized"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      # Termination handling
      terminationGracePeriodSeconds: 30
      containers:
      - name: rust-engine
        image: ghcr.io/a01009408629-netizen/market-intel-brain-rust-engine:latest
        ports:
        - containerPort: 50052
          name: grpc
        - containerPort: 9090
          name: metrics
        env:
        - name: CLUSTER_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['cluster-name']
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SPOT_INSTANCE
          value: "true"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        # Graceful shutdown handling
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c"]
              args:
              - |
                echo "Rust Engine pod received termination signal, starting graceful shutdown..."
                # Stop accepting new gRPC connections
                curl -X POST http://localhost:9090/shutdown || true
                # Wait for connections to drain
                sleep 20
                echo "Graceful shutdown completed"
        # Signal handling
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        # Health checks
        livenessProbe:
          grpc:
            port: 50052
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          grpc:
            port: 50052
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
---
# Analytics Service Deployment with Spot Instance Affinity
apiVersion: apps/v1
kind: Deployment
metadata:
  name: analytics-deployment
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: analytics
    deployment-type: spot-optimized
spec:
  replicas: 1
  selector:
    matchLabels:
      app: market-intel-brain
      component: analytics
  template:
    metadata:
      labels:
        app: market-intel-brain
        component: analytics
        spot-optimized: "true"
    spec:
      # Node affinity for spot instances
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-lifecycle
                operator: In
                values:
                - spot
              - key: spot-instance
                operator: In
                values:
                - "true"
              - key: memory-optimized
                operator: In
                values:
                - "true"
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - analytics
          - weight: 50
            preference:
              matchExpressions:
              - key: cost-optimized
                operator: In
                values:
                - "true"
      # Tolerations for spot instances
      tolerations:
      - key: "spot-instance"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      - key: "node-lifecycle"
        operator: "Equal"
        value: "spot"
        effect: "NoSchedule"
      - key: "memory-optimized"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      # Termination handling
      terminationGracePeriodSeconds: 30
      containers:
      - name: analytics
        image: ghcr.io/a01009408629-netizen/market-intel-brain-analytics:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        env:
        - name: CLUSTER_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['cluster-name']
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SPOT_INSTANCE
          value: "true"
        resources:
          requests:
            memory: "2Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "1000m"
        # Graceful shutdown handling
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c"]
              args:
              - |
                echo "Analytics pod received termination signal, starting graceful shutdown..."
                # Stop accepting new requests
                curl -X POST http://localhost:8080/shutdown || true
                # Wait for processing to complete
                sleep 25
                echo "Graceful shutdown completed"
        # Signal handling
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
---
# Vector Store Deployment with Spot Instance Affinity
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vector-store-deployment
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: vector-store
    deployment-type: spot-optimized
spec:
  replicas: 1
  selector:
    matchLabels:
      app: market-intel-brain
      component: vector-store
  template:
    metadata:
      labels:
        app: market-intel-brain
        component: vector-store
        spot-optimized: "true"
    spec:
      # Node affinity for spot instances
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-lifecycle
                operator: In
                values:
                - spot
              - key: spot-instance
                operator: In
                values:
                - "true"
              - key: memory-optimized
                operator: In
                values:
                - "true"
              - key: vector-store
                operator: In
                values:
                - "true"
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - vector-store
          - weight: 50
            preference:
              matchExpressions:
              - key: cost-optimized
                operator: In
                values:
                - "true"
      # Tolerations for spot instances
      tolerations:
      - key: "spot-instance"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      - key: "node-lifecycle"
        operator: "Equal"
        value: "spot"
        effect: "NoSchedule"
      - key: "memory-optimized"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      - key: "vector-store"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      # Termination handling
      terminationGracePeriodSeconds: 30
      containers:
      - name: vector-store
        image: ghcr.io/a01009408629-netizen/market-intel-brain-vector-store:latest
        ports:
        - containerPort: 6333
          name: qdrant
        - containerPort: 9090
          name: metrics
        env:
        - name: CLUSTER_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['cluster-name']
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SPOT_INSTANCE
          value: "true"
        resources:
          requests:
            memory: "4Gi"
            cpu: "1000m"
          limits:
            memory: "8Gi"
            cpu: "2000m"
        # Graceful shutdown handling
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c"]
              args:
              - |
                echo "Vector Store pod received termination signal, starting graceful shutdown..."
                # Stop accepting new requests
                curl -X POST http://localhost:9090/shutdown || true
                # Wait for operations to complete
                sleep 30
                echo "Graceful shutdown completed"
        # Signal handling
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 6333
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 6333
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
---
# PriorityClass for Spot Instances
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: spot-instance-priority
  labels:
    app: market-intel-brain
    component: resource-optimization
    priority-class: "spot"
  annotations:
    description: "Priority class for spot instance workloads"
    priority-class.kubernetes.io/is-default-class: "false"
value: 5000
globalDefault: false
description: "Priority class for spot instance workloads with lower priority than on-demand instances"
