---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: analytics-scaledobject
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: analytics
    autoscaling: keda
  annotations:
    scaledobject.keda.sh/transfer-hpa-owner: "true"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  scaleTargetRef:
    name: analytics-deployment
    service: analytics-service
  pollingInterval: 15         # Default: 30 seconds
  cooldownPeriod: 90          # Default: 300 seconds
  idleReplicaCount: 0         # Scale to zero when idle
  minReplicaCount: 0          # Minimum replicas (can scale to zero)
  maxReplicaCount: 20         # Maximum replicas for burst analytics traffic
  fallback:                   # Fallback configuration
    failureThreshold: 3       # Number of consecutive failed scalings before fallback
    replicas: 1               # Fallback replica count
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 0      # Immediate scale-up for burst traffic
          policies:
            - type: Pods
              value: 5                       # Scale up by 5 pods at once
              periodSeconds: 15              # Every 15 seconds
            - type: Percent
              value: 400                     # Scale up by 400% at once
              periodSeconds: 20              # Every 20 seconds
          selectPolicy: Max                  # Use the maximum change
        scaleDown:
          stabilizationWindowSeconds: 300    # Conservative scale-down (5 minutes)
          policies:
            - type: Pods
              value: 1                       # Scale down by 1 pod at once
              periodSeconds: 60              # Every 1 minute
            - type: Percent
              value: 50                      # Scale down by 50% at once
              periodSeconds: 120             # Every 2 minutes
          selectPolicy: Min                  # Use the minimum change
  triggers:
    # Kafka Topic Lag Trigger (Primary)
    - type: kafka
      metadata:
        bootstrapServers: redpanda-0.redpanda.market-intel-brain.svc.cluster.local:9092,redpanda-1.redpanda.market-intel-brain.svc.cluster.local:9092,redpanda-2.redpanda.market-intel-brain.svc.cluster.local:9092
        consumerGroup: analytics-processor
        topic: market-intel-analytics
        lagThreshold: "5000"                 # Scale when Kafka lag > 5000 messages
        activationLagThreshold: "1000"      # Activate when Kafka lag > 1000 messages
        offsetResetPolicy: latest
        allowIdleConsumers: "false"
    # Analytics Events Rate Trigger
    - type: prometheus
      metadata:
        serverAddress: http://prometheus-service.market-intel-brain-observability.svc.cluster.local:9090
        query: |
          sum(
            rate(
              analytics_events_published_total{
                service="rust-engine",
                namespace="market-intel-brain"
              }[2m]
            )
          )
        threshold: "2000"                   # Scale when analytics events per second > 2000
        activationThreshold: "500"            # Activate when analytics events per second > 500
        metricName: "analytics_events_per_second"
    # Kafka Producer Rate Trigger
    - type: prometheus
      metadata:
        serverAddress: http://prometheus-service.market-intel-brain-observability.svc.cluster.local:9090
        query: |
          sum(
            rate(
              kafka_producer_record_send_total{
                topic="market-intel-analytics",
                namespace="market-intel-brain"
              }[2m]
            )
          )
        threshold: "1500"                   # Scale when Kafka producer rate > 1500/sec
        activationThreshold: "300"            # Activate when Kafka producer rate > 300/sec
        metricName: "kafka_producer_rate"
    # CPU Usage Trigger (Secondary)
    - type: prometheus
      metadata:
        serverAddress: http://prometheus-service.market-intel-brain-observability.svc.cluster.local:9090
        query: |
          sum(
            rate(
              container_cpu_usage_seconds_total{
                pod=~"analytics-.*",
                namespace="market-intel-brain",
                container!="POD",
                container!=""
              }[2m]
            )
          ) / sum(
            kube_pod_container_resource_requests{
                pod=~"analytics-.*",
                namespace="market-intel-brain",
                resource="cpu"
              }
          ) * 100
        threshold: "80"                     # Scale when CPU usage > 80%
        activationThreshold: "60"            # Activate when CPU usage > 60%
        metricName: "cpu_usage_percent"
    # Memory Usage Trigger (Secondary)
    - type: prometheus
      metadata:
        serverAddress: http://prometheus-service.market-intel-brain-observability.svc.cluster.local:9090
        query: |
          sum(
            container_memory_working_set_bytes{
              pod=~"analytics-.*",
              namespace="market-intel-brain",
              container!="POD",
              container!=""
            }
          ) / sum(
            kube_pod_container_resource_requests{
                pod=~"analytics-.*",
                namespace="market-intel-brain",
                resource="memory"
            }
          ) * 100
        threshold: "85"                     # Scale when memory usage > 85%
        activationThreshold: "65"            # Activate when memory usage > 65%
        metricName: "memory_usage_percent"
---
# KEDA Authentication for Kafka
apiVersion: v1
kind: Secret
metadata:
  name: keda-kafka-secret
  namespace: market-intel-brain
type: Opaque
data:
  # Base64 encoded SASL credentials (empty for now)
  saslUsername: ""
  saslPassword: ""
  # Base64 encoded TLS certificates (empty for internal Redpanda)
  tls: ""
---
# ServiceMonitor for Analytics Metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: analytics-servicemonitor
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: analytics
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: market-intel-brain
      component: analytics
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true
---
# PrometheusRule for Analytics Autoscaling Metrics
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: analytics-autoscaling-rules
  namespace: market-intel-brain
  labels:
    app: market-intel-brain
    component: analytics
    autoscaling: keda
spec:
  groups:
    - name: analytics-autoscaling
      rules:
        # Kafka Consumer Lag
        - record: analytics:kafka_consumer_lag:sum
          expr: |
            sum(
              kafka_consumer_lag{
                consumer_group="analytics-processor",
                namespace="market-intel-brain"
              }
            )
          labels:
            component: analytics
            autoscaling_metric: "kafka_lag"
        # Analytics Events Per Second
        - record: analytics:events_per_second:rate2m
          expr: |
            sum(
              rate(
                analytics_events_published_total{
                  service="rust-engine",
                  namespace="market-intel-brain"
                }[2m]
              )
            )
          labels:
            component: analytics
            autoscaling_metric: "events_rps"
        # Kafka Producer Rate
        - record: analytics:kafka_producer_rate:rate2m
          expr: |
            sum(
              rate(
                kafka_producer_record_send_total{
                  topic="market-intel-analytics",
                  namespace="market-intel-brain"
                }[2m]
              )
            )
          labels:
            component: analytics
            autoscaling_metric: "producer_rps"
        # CPU Usage Percentage
        - record: analytics:cpu_usage_percent:rate2m
          expr: |
            sum(
              rate(
                container_cpu_usage_seconds_total{
                  pod=~"analytics-.*",
                  namespace="market-intel-brain",
                  container!="POD",
                  container!=""
                }[2m]
              )
            ) / sum(
              kube_pod_container_resource_requests{
                  pod=~"analytics-.*",
                  namespace="market-intel-brain",
                  resource="cpu"
                }
            ) * 100
          labels:
            component: analytics
            autoscaling_metric: "cpu_usage"
        # Memory Usage Percentage
        - record: analytics:memory_usage_percent
          expr: |
            sum(
              container_memory_working_set_bytes{
                pod=~"analytics-.*",
                namespace="market-intel-brain",
                container!="POD",
                container!=""
              }
            ) / sum(
              kube_pod_container_resource_requests{
                  pod=~"analytics-.*",
                  namespace="market-intel-brain",
                  resource="memory"
                }
            ) * 100
          labels:
            component: analytics
            autoscaling_metric: "memory_usage"
