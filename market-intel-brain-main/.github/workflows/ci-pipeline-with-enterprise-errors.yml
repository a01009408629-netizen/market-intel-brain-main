name: CI Pipeline - Clean (Rust & Go Only)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.21'
  RUST_VERSION: '1.75'
  BUF_VERSION: '1.28.1'

jobs:
  # Go Service CI Pipeline
  go-service:
    name: Go Service CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./microservices/go-services/api-gateway
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: ./microservices/go-services/api-gateway/go.mod
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Install golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        working-directory: ./microservices/go-services/api-gateway
        
    - name: Check Go formatting
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "The following files are not formatted:"
          gofmt -s -l .
          exit 1
        fi
        
    - name: Run golangci-lint
      run: golangci-lint run --timeout=5m
      
    - name: Download dependencies
      run: go mod download
      
    - name: Verify dependencies
      run: go mod verify
      
    - name: Run Go unit tests with race detector
      run: go test -v -race -coverprofile=coverage.out ./...
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./microservices/go-services/api-gateway/coverage.out
        flags: go
        name: go-coverage
        
    - name: Build Go binary
      run: go build -v -o api-gateway ./cmd/api-gateway
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Go Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./microservices/go-services/api-gateway
        file: ./microservices/go-services/api-gateway/Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/market-intel-api-gateway:latest
          ${{ secrets.DOCKER_USERNAME }}/market-intel-api-gateway:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # Rust Service CI Pipeline
  rust-service:
    name: Rust Service CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./microservices/rust-services/core-engine
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_VERSION }}
        components: rustfmt, clippy
        override: true
        
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Check Rust formatting
      run: cargo fmt --all -- --check
      
    - name: Run Clippy (fail on warnings)
      run: cargo clippy --all-targets --all-features -- -D warnings
      
    - name: Run Rust unit tests
      run: cargo test --all-features --verbose
      
    - name: Generate test coverage
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out Xml --output-dir ./coverage
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./microservices/rust-services/core-engine/coverage/cobertura.xml
        flags: rust
        name: rust-coverage
        
    - name: Build Rust binary (release)
      run: cargo build --release --verbose
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Rust Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./microservices/rust-services/core-engine
        file: ./microservices/rust-services/core-engine/Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/market-intel-core-engine:latest
          ${{ secrets.DOCKER_USERNAME }}/market-intel-core-engine:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # Protobuf Contract Validation
  protobuf-check:
    name: Protobuf Contract Validation
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./microservices/proto
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install buf
      run: |
        curl -sSL "https://github.com/bufbuild/buf/releases/download/v${{ env.BUF_VERSION }}/buf-$(uname -s)-$(uname -m)" -o "/tmp/buf"
        chmod +x "/tmp/buf"
        sudo mv "/tmp/buf" /usr/local/bin/buf
        
    - name: Verify buf.yaml configuration
      run: buf config validate
      
    - name: Lint protobuf files
      run: buf lint
      
    - name: Check for breaking changes
      run: buf breaking --against 'https://github.com/${{ github.repository }}.git#branch=main'
      
    - name: Generate protobuf documentation
      run: buf generate --template buf.md
      
    - name: Upload protobuf documentation
      uses: actions/upload-artifact@v4
      with:
        name: protobuf-docs
        path: ./microservices/proto/buf.md

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [go-service, rust-service]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        
    - name: Start observability stack
      run: |
        cd microservices
        docker-compose -f docker-compose-observability.yml up -d
        
    - name: Wait for services to be ready
      run: |
        cd microservices
        timeout 300 bash -c 'until docker-compose -f docker-compose-observability.yml ps | grep -q "healthy"; do sleep 5; done'
        
    - name: Build and start services
      run: |
        cd microservices
        docker-compose -f docker-compose.yml up -d --build
        
    - name: Wait for application services
      run: |
        cd microservices
        timeout 300 bash -c 'until curl -f http://localhost:8080/api/v1/health; do sleep 5; done'
        timeout 300 bash -c 'until curl -f http://localhost:50052; do sleep 5; done'
        
    - name: Run integration tests
      run: |
        cd microservices
        docker-compose -f docker-compose.yml exec api-gateway go test -v ./...
        docker-compose -f docker-compose.yml exec core-engine cargo test
        
    - name: Run E2E validation script
      run: |
        cd microservices/scripts
        chmod +x e2e-validation.sh
        ./e2e-validation.sh
        
    - name: Collect logs
      if: failure()
      run: |
        cd microservices
        docker-compose -f docker-compose.yml logs --no-color > integration-test-logs.txt
        docker-compose -f docker-compose-observability.yml logs --no-color > observability-logs.txt
        
    - name: Upload test logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-logs
        path: |
          ./microservices/integration-test-logs.txt
          ./microservices/observability-logs.txt

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Gosec Security Scanner
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: './microservices/go-services/api-gateway/...'
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: Run Rust security audit
      uses: EmbarkStudios/cargo-deny-action@v1
      with:
        command: check
        working-directory: ./microservices/rust-services/core-engine

  # Performance Benchmarks
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [go-service, rust-service]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run Go benchmarks
      run: |
        cd microservices/go-services/api-gateway
        go test -bench=. -benchmem -count=3 ./...
        
    - name: Run Rust benchmarks
      run: |
        cd microservices/rust-services/core-engine
        cargo bench
        
    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'cargo'
        output-file-path: microservices/rust-services/core-engine/target/criterion/reports/index.html
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        comment-on-alert: true
        alert-threshold: '200%'
        fail-on-alert: true

  # Deploy to Staging (only on main branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [go-service, rust-service, protobuf-check, integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your deployment commands here
        # For example: kubectl apply -f k8s/staging/
        
    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        # Add smoke test commands here
