name: High-Efficiency CI with Auto-Fix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ===== AUTO-FIX AND VALIDATION =====
  auto-fix:
    name: üîß Auto-Fix & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
          components: rustfmt, clippy

      - name: üì¶ Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: üêπ Setup Go 1.21
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: ./microservices/go-services/api-gateway/go.mod

      - name: üì¶ Install Protocol Buffer Compiler
        run: |
          sudo apt-get update
          sudo apt-get update && sudo apt-get install -y protobuf-compiler libsasl2-dev

      - name: üì¶ Install Go Protobuf Plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: üîß Generate Protocol Buffers
        run: |
          echo "üîß Generating protocol buffers..."
          
          # Generate from microservices/proto
          mkdir -p microservices/go-services/api-gateway/pb
          protoc --go_out=. --go-grpc_out=. --go_opt=paths=source_relative \
            microservices/proto/*.proto \
            microservices/proto/versions/v1/*.proto
          
          # Move generated files to pb directory if needed
          find . -name "*.pb.go" -not -path "./pb/*" -exec mv {} ./pb/ \;
          find . -name "*_grpc.pb.go" -not -path "./pb/*" -exec mv {} ./pb/ \;
          
          echo "‚úÖ Protocol buffers generated"

      - name: üì¶ Install golangci-lint
        run: |
          echo "üì¶ Installing golangci-lint..."
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2
          echo "‚úÖ golangci-lint installed"
          echo "üîç Adding to PATH..."
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: üîß Execute go mod tidy
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîß Running go mod tidy..."
          go mod tidy
          echo "‚úÖ go mod tidy completed"

      - name: üîß Execute go mod vendor
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîß Running go mod vendor..."
          go mod vendor
          echo "‚úÖ go mod vendor completed"

      - name: üîç Verify Vendor Sync
        working-directory: ./microservices/go-services/api-gateway
        run: |
          echo "üîç Verifying vendor sync..."
          if [ ! -d "vendor" ]; then
            echo "‚ùå Vendor directory not found"
            exit 1
          fi
          if [ ! -f "vendor/modules.txt" ]; then
            echo "‚ùå vendor/modules.txt not found"
            exit 1
          fi
          echo "‚úÖ Vendor sync verification passed"

      - name: üîß Run golangci-lint with --fix
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîß Running golangci-lint with --fix..."
          export PATH="$(go env GOPATH)/bin:$PATH"
          golangci-lint run --fix ./...
          echo "‚úÖ golangci-lint --fix completed"

      - name: üì§ Auto-Commit Fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: automated fix [skip ci]"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          file_pattern: |
            microservices/go-services/api-gateway/go.mod
            microservices/go-services/api-gateway/go.sum
            microservices/go-services/api-gateway/vendor/
            microservices/go-services/api-gateway/**/*.go
            microservices/go-services/api-gateway/pb/
          skip_dirty_check: false
          skip_fetch: false
          commit_options: "--no-verify --signoff"

  # ===== BUILD AND TEST =====
  build-test:
    name: üèóÔ∏è Build & Test
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
          components: rustfmt, clippy

      - name: üêπ Setup Go 1.21
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: üì¶ Install Protocol Buffer Compiler
        run: |
          sudo apt-get update
          sudo apt-get update && sudo apt-get install -y protobuf-compiler libsasl2-dev

      - name: üì¶ Install Go Protobuf Plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: üîß Generate Protocol Buffers
        run: |
          echo "üîß Generating protocol buffers..."
          
          # Generate from microservices/proto
          mkdir -p microservices/go-services/api-gateway/pb
          protoc --go_out=. --go-grpc_out=. --go_opt=paths=source_relative \
            microservices/proto/*.proto \
            microservices/proto/versions/v1/*.proto
          
          # Move generated files to pb directory if needed
          find . -name "*.pb.go" -not -path "./pb/*" -exec mv {} ./pb/ \;
          find . -name "*_grpc.pb.go" -not -path "./pb/*" -exec mv {} ./pb/ \;
          
          echo "‚úÖ Protocol buffers generated"

      - name: üîç Validate Linting (No Fixes)
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Validating linting (no fixes allowed)..."
          export PATH="$(go env GOPATH)/bin:$PATH"
          golangci-lint run --timeout=10m ./...
          echo "‚úÖ Linting validation passed"

      - name: üèóÔ∏è Build Service
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üèóÔ∏è Building service..."
          go build -o bin/api-gateway ./cmd/api-gateway/main.go
          echo "‚úÖ Build completed successfully"

      - name: üß™ Run Tests
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üß™ Running tests..."
          go test -v -race -coverprofile=coverage.out ./...
          echo "‚úÖ Tests completed successfully"

      - name: üìä Upload Coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  # ===== LOGIC VALIDATION =====
  logic-validation:
    name: üîç Logic Validation
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
          components: rustfmt, clippy

      - name: üêπ Setup Go 1.21
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: ./microservices/go-services/api-gateway/go.mod

      - name: üì¶ Install Protocol Buffer Compiler
        run: |
          sudo apt-get update
          sudo apt-get update && sudo apt-get install -y protobuf-compiler libsasl2-dev

      - name: üì¶ Install Go Protobuf Plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: üîß Generate Protocol Buffers
        run: |
          echo "üîß Generating protocol buffers..."
          
          # Generate from microservices/proto
          mkdir -p microservices/go-services/api-gateway/pb
          protoc --go_out=. --go-grpc_out=. --go_opt=paths=source_relative \
            microservices/proto/*.proto \
            microservices/proto/versions/v1/*.proto
          
          # Move generated files to pb directory if needed
          find . -name "*.pb.go" -not -path "./pb/*" -exec mv {} ./pb/ \;
          find . -name "*_grpc.pb.go" -not -path "./pb/*" -exec mv {} ./pb/ \;
          
          echo "‚úÖ Protocol buffers generated"

      - name: üîç Validate Go Module Structure
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Validating Go module structure..."
          
          # Check if go.mod exists and is valid
          if [ ! -f "go.mod" ]; then
            echo "‚ùå go.mod file not found"
            exit 1
          fi
          
          # Check if vendor directory exists
          if [ ! -d "vendor" ]; then
            echo "‚ùå vendor directory not found"
            exit 1
          fi
          
          # Validate go.mod syntax
          if ! go mod verify; then
            echo "‚ùå go.mod verification failed"
            exit 1
          fi
          
          echo "‚úÖ Go module structure validation passed"

      - name: üîç Validate Import Paths
        working-directory: ./microservices/go-services/api-gateway
        run: |
          echo "üîç Validating import paths..."
          
          # Check for invalid import paths
          if grep -r "go.opentelemetry.io/otel/semconv/v1.24.0" .; then
            echo "‚ùå Invalid OpenTelemetry semconv import path found"
            exit 1
          fi
          
          echo "‚úÖ Import paths validation passed"

      - name: üîç Validate Build Dependencies
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Validating build dependencies..."
          
          # Try to build without errors
          if ! go build -o /tmp/test-build ./cmd/api-gateway/main.go; then
            echo "‚ùå Build validation failed - unfixable logic error"
            exit 1
          fi
          
          echo "‚úÖ Build dependencies validation passed"

  # ===== SECURITY SCAN =====
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: auto-fix
    if: always()
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
          components: rustfmt, clippy

      - name: üì¶ Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: üîç Rust Security Audit
        working-directory: ./microservices/rust-services
        run: cargo audit

      - name: üêπ Setup Go 1.21
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Git Auth
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Run Security Scan
        working-directory: ./microservices/go-services/api-gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          ./bin/gosec ./...

      - name: üì§ Upload Security Report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ./microservices/go-services/api-gateway/gosec-report.sarif
