name: CI with Auto-Fix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Concurrency control to cancel redundant runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.21'
  RUST_VERSION: 'stable'

jobs:
  # ===== AUTO-FIX JOB =====
  auto-fix:
    name: ðŸ”§ Auto-Fix Dependencies & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ./microservices/go-services/api-gateway/go.mod

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          echo "âœ… Dependencies installed"

      - name: ðŸ”§ Run Auto-Fix
        run: |
          echo "ðŸ”§ Running auto-fix..."
          cd microservices/go-services/api-gateway
          
          # Fix Go dependencies
          echo "ðŸ”§ Fixing Go dependencies..."
          go mod tidy
          go mod vendor
          
          # Fix Go linting issues
          echo "ðŸ”§ Fixing Go linting issues..."
          golangci-lint run --fix
          
          # Fix Rust formatting
          echo "ðŸ”§ Fixing Rust formatting..."
          cd ../rust-services/core-engine
          cargo fmt --all
          
          echo "âœ… Auto-fix completed"

      - name: ðŸ“¤ Auto-Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”§ Auto-fix: Dependencies & Linting"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          file_pattern: |
            microservices/go-services/api-gateway/go.mod
            microservices/go-services/api-gateway/go.sum
            microservices/go-services/api-gateway/vendor/
            microservices/rust-services/core-engine/src/
          skip_dirty_check: false
          skip_fetch: false

  # ===== LINTING & QUALITY =====
  lint-quality:
    name: ðŸ” Linting & Quality
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ./microservices/go-services/api-gateway/go.mod

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: ðŸ”§ Go Linting & Formatting
        working-directory: ./microservices/go-services/api-gateway
        run: |
          echo "ðŸ” Running Go quality checks..."
          
          # Check formatting
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "âŒ Go files are not formatted:"
            gofmt -s -l .
            exit 1
          fi
          echo "âœ… Go formatting check passed"
          
          # Install and run golangci-lint
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run --timeout=10m --verbose
          echo "âœ… Go linting completed"

      - name: ðŸ¦€ Rust Linting & Formatting
        working-directory: ./microservices/rust-services/core-engine
        run: |
          echo "ðŸ” Running Rust quality checks..."
          
          # Check formatting
          cargo fmt --all -- --check
          echo "âœ… Rust formatting check passed"
          
          # Run clippy
          cargo clippy --all-targets --all-features -- -D warnings
          echo "âœ… Rust clippy completed"

  # ===== BUILD & TEST =====
  build-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: [lint-quality]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ./microservices/go-services/api-gateway/go.mod

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: ðŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-ci-${{ hashFiles('**/go.sum', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-ci-

      - name: ðŸ—ï¸ Build Go Service
        working-directory: ./microservices/go-services/api-gateway
        run: |
          echo "ðŸ—ï¸ Building Go service..."
          go build -o bin/api-gateway ./cmd/main.go
          echo "âœ… Go service built successfully"

      - name: ðŸ—ï¸ Build Rust Service
        working-directory: ./microservices/rust-services/core-engine
        run: |
          echo "ðŸ—ï¸ Building Rust service..."
          cargo build --release
          echo "âœ… Rust service built successfully"

      - name: ðŸ§ª Test Go Service
        working-directory: ./microservices/go-services/api-gateway
        run: |
          echo "ðŸ§ª Testing Go service..."
          go test -v ./...
          echo "âœ… Go tests completed"

      - name: ðŸ§ª Test Rust Service
        working-directory: ./microservices/rust-services/core-engine
        run: |
          echo "ðŸ§ª Testing Rust service..."
          cargo test --all
          echo "âœ… Rust tests completed"

  # ===== SECURITY SCAN =====
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [auto-fix]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: ðŸ” Go Security Scan
        working-directory: ./microservices/go-services/api-gateway
        run: |
          echo "ðŸ” Running Go security scan..."
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec -fmt sarif -out gosec-report.sarif ./...
          echo "âœ… Go security scan completed"

      - name: ðŸ” Rust Security Scan
        working-directory: ./microservices/rust-services/core-engine
        run: |
          echo "ðŸ” Running Rust security scan..."
          cargo install cargo-audit
          cargo audit --json > cargo-audit.json || true
          echo "âœ… Rust security scan completed"

      - name: ðŸ“¤ Upload Security Reports
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ./microservices/go-services/api-gateway/gosec-report.sarif
