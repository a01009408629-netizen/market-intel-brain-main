name: ğŸ¦€ Rust CI/CD Pipeline for Market Intel Brain

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Environment variables
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Concurrency control
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== BUILD AND TEST JOB =====
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦€ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
          targets: x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ”§ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libpq-dev \
            build-essential

      - name: ğŸ“‹ Format Check
        run: cargo fmt --all -- --check

      - name: ğŸ” Clippy Check
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ—ï¸ Build Debug
        run: cargo build --verbose

      - name: ğŸ§ª Run Tests
        run: cargo test --verbose

      - name: ğŸ—ï¸ Build Release
        run: cargo build --release --verbose

      - name: ğŸ“Š Generate Documentation
        run: cargo doc --no-deps --document-private-items

      - name: ğŸ“¤ Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: target/doc/
          retention-days: 30

  # ===== SECURITY SCAN JOB =====
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ” Install cargo-audit
        run: cargo install cargo-audit

      - name: ğŸ” Security Audit
        run: cargo audit

      - name: ğŸ” Install cargo-deny
        run: cargo install cargo-deny

      - name: ğŸ” Dependency Check
        run: cargo deny check

      - name: ğŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            cargo-audit-report.json
            cargo-deny-report.json
          retention-days: 90

  # ===== BENCHMARK JOB =====
  benchmark:
    name: ğŸ“ˆ Benchmark
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ—ï¸ Build Release
        run: cargo build --release

      - name: ğŸ“ˆ Run Benchmarks
        run: |
          if [ -d "benches" ]; then
            cargo bench --all-targets
          else
            echo "No benchmarks found"
          fi

      - name: ğŸ“¤ Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            target/criterion/
          retention-days: 30

  # ===== DOCKER BUILD JOB =====
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ·ï¸ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: false
          load: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== DEPLOYMENT JOBS =====
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "Build: ${{ needs.build-and-test.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
          
          # Add your staging deployment commands here
          # Example: kubectl apply -f k8s/staging/
          # Example: docker-compose -f docker-compose.staging.yml up -d

      - name: ğŸ§ª Run Staging Tests
        run: |
          echo "ğŸ§ª Running staging tests..."
          # Add staging test commands here

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, benchmark]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸš€ Deploying to production environment..."
          echo "Build: ${{ needs.build-and-test.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
          echo "Benchmark: ${{ needs.benchmark.result }}"
          
          # Add your production deployment commands here
          # Example: kubectl apply -f k8s/production/
          # Example: docker-compose -f docker-compose.prod.yml up -d

      - name: ğŸ§ª Run Production Tests
        run: |
          echo "ğŸ§ª Running production tests..."
          # Add production test commands here

  # ===== NOTIFICATION JOB =====
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: always()
    
    steps:
      - name: ğŸ“¢ Send Notification
        run: |
          echo "ğŸ“¢ Pipeline completed!"
          echo "Build: ${{ needs.build-and-test.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
          
          # Add notification logic here
          # Example: Slack webhook, email, etc.
